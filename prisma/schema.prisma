// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

// User Entity
// Requirements: 2.3, 3.1, 3.2, 3.4, 7.1
model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  emailVerified      DateTime?
  passwordHash       String
  firstName          String
  lastName           String
  phoneNumber        String?
  language           String    @default("en-US")
  role               UserRole  @default(USER)
  status             UserStatus @default(ACTIVE)
  apiKey             String?   @unique
  currentWorkspaceId String?
  hasUsedTrial       Boolean   @default(false)
  trialUsedAt        DateTime?
  lastSeenAt         DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  sessions           Session[]
  accounts           Account[]
  ownedWorkspaces    Workspace[] @relation("WorkspaceOwner")
  currentWorkspace   Workspace?  @relation("CurrentWorkspace", fields: [currentWorkspaceId], references: [id], onDelete: SetNull)
  workspaceMembers   WorkspaceMember[]
  conversations      Conversation[]
  generations        Generation[]
  files              File[]
  documents          Document[]
  affiliate          Affiliate?
  referrals          Referral[]
  adminActions       AdminAction[] @relation("AdminActions")
  systemSettingUpdates SystemSetting[] @relation("SystemSettingUpdates")
  announcements      Announcement[] @relation("AnnouncementCreator")

  @@index([email])
  @@index([apiKey])
  @@index([currentWorkspaceId])
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// Workspace Entity
// Requirements: 2.3, 8.1, 8.2, 8.3, 8.4, 8.5
model Workspace {
  id                String    @id @default(uuid())
  name              String
  ownerId           String
  creditCount       Int       @default(0)
  allocatedCredits  Int       @default(0)
  isTrialed         Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  creditsAdjustedAt DateTime?

  // Relations
  owner             User      @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members           WorkspaceMember[]
  currentUsers      User[]    @relation("CurrentWorkspace")
  conversations     Conversation[]
  generations       Generation[]
  presets           Preset[]
  files             File[]
  documents         Document[]
  voices            Voice[]
  subscription      Subscription?
  invoices          Invoice[]
  paymentMethods    PaymentMethod[]
  creditTransactions CreditTransaction[]

  @@index([ownerId])
  @@map("workspaces")
}

// WorkspaceMember - Join table for workspace members
// Requirements: 8.2, 8.3
model WorkspaceMember {
  id          String   @id @default(uuid())
  workspaceId String
  userId      String
  role        WorkspaceMemberRole @default(MEMBER)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@map("workspace_members")
}

enum WorkspaceMemberRole {
  OWNER
  ADMIN
  MEMBER
}

// Session Entity
// Requirements: 2.3, 6.1, 6.2, 6.4, 6.5
model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@index([userId])
  @@index([expires])
  @@map("sessions")
}

// Account Entity - For OAuth and future authentication providers
// Requirements: 2.3
model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refreshToken      String? @db.Text
  accessToken       String? @db.Text
  expiresAt         Int?
  tokenType         String?
  scope             String?
  idToken           String? @db.Text
  sessionState      String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

// VerificationToken Entity
// Requirements: 2.3, 4.1, 4.3, 5.1, 5.2
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  type       VerificationTokenType
  createdAt  DateTime @default(now())

  @@unique([identifier, token])
  @@index([token])
  @@index([expires])
  @@map("verification_tokens")
}

enum VerificationTokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

// Conversation Entity
// Requirements: 3.1, 3.3
model Conversation {
  id          String    @id @default(uuid())
  workspaceId String
  userId      String
  title       String
  model       String
  provider    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages    Message[]

  @@index([workspaceId])
  @@index([userId])
  @@index([createdAt])
  @@map("conversations")
}

// Message Entity
// Requirements: 3.1, 3.3
model Message {
  id             String       @id @default(uuid())
  conversationId String
  role           MessageRole
  content        String       @db.Text
  tokens         Int          @default(0)
  credits        Int          @default(0)
  createdAt      DateTime     @default(now())

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// Generation Entity
// Requirements: 3.1, 3.3, 9.1
model Generation {
  id          String           @id @default(uuid())
  workspaceId String
  userId      String
  type        GenerationType
  model       String
  provider    String
  prompt      String           @db.Text
  result      String?          @db.Text
  tokens      Int              @default(0)
  credits     Int              @default(0)
  status      GenerationStatus @default(PENDING)
  error       String?          @db.Text
  createdAt   DateTime         @default(now())
  completedAt DateTime?

  // Relations
  workspace   Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("generations")
}

enum GenerationType {
  TEXT
  IMAGE
  SPEECH
  TRANSCRIPTION
}

enum GenerationStatus {
  PENDING
  COMPLETED
  FAILED
}

// Preset Entity
// Requirements: 9.1
model Preset {
  id          String   @id @default(uuid())
  workspaceId String?
  name        String
  description String   @db.Text
  category    String
  template    String   @db.Text
  model       String
  parameters  Json
  isPublic    Boolean  @default(false)
  usageCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([category])
  @@index([isPublic])
  @@map("presets")
}

// File Entity
// Requirements: Content Management 1.1, 1.2, 1.3, 1.4
model File {
  id          String   @id @default(uuid())
  workspaceId String
  userId      String
  name        String
  type        String
  size        Int
  url         String
  storageKey  String   @unique
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())

  // Relations
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents   Document[]
  voiceSamples Voice[]

  @@index([workspaceId])
  @@index([userId])
  @@index([storageKey])
  @@index([createdAt])
  @@map("files")
}

// Document Entity
// Requirements: Content Management 2.1, 2.2, 2.3, 2.4, 2.5
model Document {
  id           String       @id @default(uuid())
  workspaceId  String
  userId       String
  title        String
  content      String       @db.Text
  type         DocumentType
  fileId       String?
  generationId String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  workspace    Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  file         File?        @relation(fields: [fileId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([fileId])
  @@map("documents")
}

enum DocumentType {
  TEXT
  IMAGE
  AUDIO
}

// Voice Entity
// Requirements: Content Management 4.1, 4.2, 4.3, 4.4, 4.5
model Voice {
  id          String      @id @default(uuid())
  workspaceId String
  name        String
  description String      @db.Text
  sampleFileId String
  modelId     String?
  status      VoiceStatus @default(TRAINING)
  createdAt   DateTime    @default(now())

  // Relations
  workspace   Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  sampleFile  File        @relation(fields: [sampleFileId], references: [id], onDelete: Restrict)

  @@index([workspaceId])
  @@index([status])
  @@index([sampleFileId])
  @@map("voices")
}

enum VoiceStatus {
  TRAINING
  READY
  FAILED
}

// Plan Entity
// Requirements: Billing 1.1, 1.2, 1.3, 1.4, 1.5
model Plan {
  id              String   @id @default(uuid())
  name            String
  description     String   @db.Text
  price           Int      // Price in cents
  currency        String   @default("usd")
  interval        PlanInterval
  creditCount     Int?     // null = unlimited
  features        Json     @default("[]")
  limits          Json     @default("{}")
  stripeProductId String   @unique
  stripePriceId   String   @unique
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  subscriptions   Subscription[]

  @@index([isActive])
  @@index([stripeProductId])
  @@index([stripePriceId])
  @@map("plans")
}

enum PlanInterval {
  MONTH
  YEAR
}

// Subscription Entity
// Requirements: Billing 2.1, 2.2, 2.3, 3.1, 3.2, 3.3, 3.4, 3.5
model Subscription {
  id                   String             @id @default(uuid())
  workspaceId          String             @unique
  planId               String
  stripeSubscriptionId String             @unique
  stripeCustomerId     String
  status               SubscriptionStatus
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  trialEnd             DateTime?
  version              Int                @default(0)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  // Relations
  workspace            Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  plan                 Plan               @relation(fields: [planId], references: [id], onDelete: Restrict)
  invoices             Invoice[]

  @@index([workspaceId])
  @@index([planId])
  @@index([stripeSubscriptionId])
  @@index([stripeCustomerId])
  @@index([status])
  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
  INCOMPLETE
  INCOMPLETE_EXPIRED
  UNPAID
}

// Invoice Entity
// Requirements: Billing 5.1, 5.2, 5.3, 5.4, 5.5
model Invoice {
  id               String        @id @default(uuid())
  workspaceId      String
  subscriptionId   String?
  stripeInvoiceId  String        @unique
  amount           Int           // Amount in cents
  currency         String        @default("usd")
  status           InvoiceStatus
  paidAt           DateTime?
  invoiceUrl       String?
  invoicePdfUrl    String?
  description      String?       @db.Text
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  workspace        Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  subscription     Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([subscriptionId])
  @@index([stripeInvoiceId])
  @@index([status])
  @@index([createdAt])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

// PaymentMethod Entity
// Requirements: Billing 6.1, 6.2, 6.3, 6.4, 6.5
model PaymentMethod {
  id                     String   @id @default(uuid())
  workspaceId            String
  stripePaymentMethodId  String   @unique
  type                   String   // card, bank_account, etc.
  last4                  String?
  brand                  String?
  expiryMonth            Int?
  expiryYear             Int?
  isDefault              Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Relations
  workspace              Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([stripePaymentMethodId])
  @@index([isDefault])
  @@map("payment_methods")
}

// CreditTransaction Entity
// Requirements: Billing 4.5, 10.1, 10.2, 10.3, 10.4
model CreditTransaction {
  id              String                  @id @default(uuid())
  workspaceId     String
  amount          Int                     // Positive for additions, negative for deductions
  type            CreditTransactionType
  description     String?                 @db.Text
  referenceId     String?                 // Invoice ID, Generation ID, etc.
  referenceType   String?                 // invoice, generation, adjustment, etc.
  balanceBefore   Int
  balanceAfter    Int
  createdAt       DateTime                @default(now())

  // Relations
  workspace       Workspace               @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([referenceId, referenceType])
  @@index([workspaceId])
  @@index([type])
  @@index([referenceId])
  @@index([createdAt])
  @@map("credit_transactions")
}

enum CreditTransactionType {
  PURCHASE
  SUBSCRIPTION_ALLOCATION
  USAGE
  REFUND
  ADJUSTMENT
  OVERAGE
}

// Affiliate Entity
// Requirements: Affiliate 1, 2, 3, 4
model Affiliate {
  id              String          @id @default(uuid())
  userId          String          @unique
  code            String          @unique
  commissionRate  Float           @default(0.1) // 10% default
  tier            Int             @default(1)
  status          AffiliateStatus @default(ACTIVE)
  totalEarnings   Int             @default(0) // Amount in cents
  pendingEarnings Int             @default(0) // Amount in cents
  paidEarnings    Int             @default(0) // Amount in cents
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  referrals       Referral[]
  payouts         Payout[]
  fraudLogs       FraudLog[]

  @@index([userId])
  @@index([code])
  @@index([status])
  @@map("affiliates")
}

enum AffiliateStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

// Referral Entity
// Requirements: Affiliate 1, 2
model Referral {
  id              String         @id @default(uuid())
  affiliateId     String
  referredUserId  String
  status          ReferralStatus @default(PENDING)
  conversionValue Int            @default(0) // Amount in cents
  commission      Int            @default(0) // Amount in cents
  convertedAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  affiliate       Affiliate      @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  referredUser    User           @relation(fields: [referredUserId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([referredUserId])
  @@index([status])
  @@index([createdAt])
  @@map("referrals")
}

enum ReferralStatus {
  PENDING
  CONVERTED
  CANCELED
}

// Payout Entity
// Requirements: Affiliate 3
model Payout {
  id          String        @id @default(uuid())
  affiliateId String
  amount      Int           // Amount in cents
  method      PayoutMethod
  status      PayoutStatus  @default(PENDING)
  processedAt DateTime?
  notes       String?       @db.Text
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  affiliate   Affiliate     @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([status])
  @@index([createdAt])
  @@map("payouts")
}

enum PayoutMethod {
  PAYPAL
  STRIPE
  BANK_TRANSFER
}

enum PayoutStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
  FAILED
}

// FraudLog Entity
// Requirements: Affiliate 5 - Fraud Prevention
model FraudLog {
  id          String           @id @default(uuid())
  affiliateId String?
  referralId  String?
  type        FraudLogType
  severity    FraudSeverity
  riskScore   Int              // 0-100
  reasons     Json             // Array of reasons
  metadata    Json             @default("{}")
  resolved    Boolean          @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  notes       String?          @db.Text
  createdAt   DateTime         @default(now())

  // Relations
  affiliate   Affiliate?       @relation(fields: [affiliateId], references: [id], onDelete: SetNull)

  @@index([affiliateId])
  @@index([type])
  @@index([severity])
  @@index([resolved])
  @@index([createdAt])
  @@map("fraud_logs")
}

enum FraudLogType {
  SELF_REFERRAL
  SUSPICIOUS_PATTERN
  RAPID_VELOCITY
  EMAIL_PATTERN
  CONVERSION_FRAUD
  COMMISSION_AUDIT
  IP_MATCH
  OTHER
}

enum FraudSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// AdminAction Entity
// Requirements: Admin Dashboard 8 - Audit Logging
model AdminAction {
  id          String   @id @default(uuid())
  adminId     String
  action      String
  targetType  String
  targetId    String
  changes     Json     @default("{}")
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  // Relations
  admin       User     @relation("AdminActions", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([targetType])
  @@index([targetId])
  @@index([createdAt])
  @@map("admin_actions")
}

// SystemSetting Entity
// Requirements: Admin Dashboard 4 - System Settings
model SystemSetting {
  key         String   @id
  value       Json
  description String?  @db.Text
  category    String   @default("general")
  isPublic    Boolean  @default(false)
  updatedBy   String
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  // Relations
  updater     User     @relation("SystemSettingUpdates", fields: [updatedBy], references: [id], onDelete: Restrict)

  @@index([category])
  @@index([updatedBy])
  @@map("system_settings")
}

// Announcement Entity
// Requirements: Admin Dashboard 7 - Support Tools
model Announcement {
  id          String            @id @default(uuid())
  title       String
  content     String            @db.Text
  type        AnnouncementType  @default(INFO)
  isActive    Boolean           @default(true)
  startDate   DateTime          @default(now())
  endDate     DateTime?
  createdBy   String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  creator     User              @relation("AnnouncementCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
  @@index([createdBy])
  @@map("announcements")
}

enum AnnouncementType {
  INFO
  WARNING
  ERROR
  SUCCESS
}
